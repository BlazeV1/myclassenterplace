let gamesJSON = [
    {
        title: "1v1.lol",
        type: "proxy",
        img: "./img/gxmes/1v1lol.png",
        src: "https://1v1.lol/"
    },
    {
        title: "Cookie Clicker",
        type: "proxy",
        img: "./img/gxmes/cookieclicker.png",
        src: "https://eli-schwartz.github.io/cookieclicker"
    },
    {
        title: "Roblox",
        type: "proxy",
        img: "./img/gxmes/roblox.webp",
        src: "https://websitesball.com"
    },
    {
        title: "Bloxd.io",
        type: "proxy",
        img: "./img/gxmes/bloxd.png",
        src: "https://bloxd.io"
    },
    {
        title: "Retro Bowl",
        type: "proxy",
        img: "./img/gxmes/retrobowl.webp",
        src: "https://game316009.konggames.com/gamez/0031/6009/live/index.html"
    },
    {
        title: "Minecraft",
        type: "proxy",
        img: "./img/gxmes/minecraft.webp",
        src: "https://sd592g.github.io/zj684od4lfg/"
    },
    {
        title: "Bitlife",
        type: "proxy",
        img: "./img/gxmes/bitlife.jpg",
        src: "https://ubg365.github.io/bitlife-life-simulator/play.html"
    },
    {
        title: "Five nights at freddys",
        type: "proxy",
        img: "./img/gxmes/fnaf.png",
        src: "https://run3.io/popgame/fnaf/fnaf1/"
    },
    {
        title: "Monkey Mart",
        type: "proxy",
        img: "./img/gxmes/monkeymart.png",
        src: "https://www.getgames.io/games/gm/MonkeyMart/index.html"
    },
    {
        title: "Moto X3M",
        type: "proxy",
        img: "./img/gxmes/motox3m.avif",
        src: "https://webglmath.github.io/moto-x3m/"
    },
    {
        title: "Worlds Hardest Game",
        type: "proxy",
        img: "./img/gxmes/whg.png",
        src: "https://watchdocumentaries.com/wp-content/uploads/games/worlds-hardest-game/"
    },
    {
        title: "Rooftop Snipers",
        type: "proxy",
        img: "./img/gxmes/rooftop_snipers.avif",
        src: "https://htmlxm.github.io/h/rooftop-snipers/"
    },
    {
        title: "Bloons TD 4",
        type: "proxy",
        img: "./img/gxmes/bloontd4.jpg",
        src: "https://www.silvergames.com/en/bloons-tower-defense-4/gameframe"
    },
    {
        title: "Subway Surfers",
        type: "proxy",
        img: "./img/gxmes/ss.webp",
        src: "https://subwaysurfersgame.io/subway-surfers.embed"
    },
    {
        title: "Smash Karts",
        type: "proxy",
        img: "./img/gxmes/shellshockers.png",
        src: "https://shellshock.io"
    },
    {
        title: "Happy Wheels",
        type: "proxy",
        img: "./img/gxmes/happywheels.png",
        src: "https://games-online.io/game/HappyWheels/"
    },
    {
        title: "Jetpack Joyride",
        type: "proxy",
        img: "./img/gxmes/jj.png",
        src: "https://ext.minijuegosgratis.com/jetpack-joyride/index.html?mp_api_as3_url=https%3A%2F%2Fssl.minijuegosgratis.com%2Flechuck%2Fas3%2Flatest.swf&mp_api_as3_url_bck=https%3A%2F%2Fapi.minijuegos.com%2Flechuck%2Fclient-as%2F&mp_api_id=4100&mp_api_js_url=https%3A%2F%2Fssl.minijuegosgratis.com%2Flechuck%2Fjs%2Flatest.js&mp_api_js_url_bck=https%3A%2F%2Fapi.minijuegos.com%2Flechuck%2Fclient-js%2F&mp_assets=https%3A%2F%2Fs2.minijuegosgratis.com%2F&mp_embed=0&mp_game_id=224491&mp_game_uid=jetpack-joyride&mp_game_url=https%3A%2F%2Fwww.miniplay.com%2Fembed%2Fjetpack-joyride&mp_int=1&mp_locale=en_US&mp_player_type=IFRAME&mp_site_https_url=https%3A%2F%2Fwww.miniplay.com%2F&mp_site_name=miniplay.com&mp_site_url=https%3A%2F%2Fwww.miniplay.com%2F&mp_timezone=America%2FChicago&mp_view_type=&mini_signature=5cf17550a654849f15716dc389b6c6ea&xdm_e=https%3A%2F%2Fwww.miniplay.com&xdm_c=default8394&xdm_p=1"
    },
    {
        title: "Chess.com",
        type: "proxy",
        img: "./img/gxmes/chess.png",
        src: "https://chess.com"
    },
    {
        title: "Time Shooter 2",
        type: "proxy",
        img: "./img/gxmes/time-shooter-2.png",
        src: "https://www.twoplayergames.org/embed/time-shooter-2"
    },
    {
        title: "Slope",
        type: "proxy",
        img: "./img/gxmes/slope.png",
        src: "https://kdata1.com/2020/05/slope/"
    },
    {
        title: "Basketbros",
        type: "proxy",
        img: "./img/gxmes/basketbros.jpeg",
        src: "https://vtune.net"
    },
    {
        title: "Google Baseball",
        type: "proxy",
        img: "./img/gxmes/googleb.png",
        src: "https://www.google.com/logos/2019/july4th19/r6/july4th19.html?hl=en"
    },
    {
        title: "The Binding of Issac",
        type: "proxy",
        img: "./img/gxmes/tboi.avif",
        src: "https://gnhustgames.org/the-binding-of-isaac-source/"
    },
    {
        title: "Deadshot.io",
        type: "proxy",
        img: "./img/gxmes/deadshot-io.png",
        src: "https://deadshot.io"
    },
    {
        title: "Paper.io",
        type: "proxy",
        img: "./img/gxmes/paperio2.png",
        src: "https://games.voodoo.com/paperio2"
    },
    {
        title: "OvO",
        type: "proxy",
        img: "./img/gxmes/ovo.png",
        src: "https://www.coolmathgames.com/0-ovo/play"
    },
    {
        title: "Drift Boss",
        type: "proxy",
        img: "./img/gxmes/driftboss.png",
        src: "https://www.mathplayground.com/drift-boss-v3/index.html"
    },
    {
        title: "Cluster Rush",
        type: "proxy",
        img: "./img/gxmes/clusterrush.png",
        src: "https://w8.snokido.com/games/unity-webgl/cluster-rush/index.html'"
    },
    {
        title: "Friday Night Funkin",
        type: "proxy",
        img: "./img/gxmes/fnf.jpg",
        src: "https://uploads.ungrounded.net/alternate/1528000/1528775_alternate_113347_r88.zip/?NewgroundsAPI_PublisherID=1&NewgroundsAPI_SandboxID=661197f20386c&NewgroundsAPI_SessionID=&NewgroundsAPI_UserName=%26lt%3Bdeleted%26gt%3B&NewgroundsAPI_UserID=0&ng_username=%26lt%3Bdeleted%26gt%3B/"
    },
    {
        title: "Wrestle Bros",
        type: "proxy",
        img: "./img/gxmes/wreslebros.png",
        src: "https://wrestlebros.io"
    },
    {
        title: "Soccer Bros",
        type: "proxy",
        img: "./img/gxmes/soccerbros.png",
        src: "https://soccerbros.gg"
    },
    {
        title: "Geometry Dash",
        type: "proxy",
        img: "./img/gxmes/geodash.svg",
        src: "https://geometrylite.io/game/geometry-lite/"
    },
    {
        title: "Bonk.io",
        type: "proxy",
        img: "./img/gxmes/bonk.io.jpg",
        src: "https://bonk.io"
    },
    {
        title: "Drift Hunters",
        type: "proxy",
        img: "./img/gxmes/dh.png",
        src: "https://drift-hunters.pages.dev/"
    },
    {
        title: "Backrooms",
        type: "proxy",
        img: "./img/gxmes/backrooms.png",
        src: "https://backrooms-ad8.pages.dev/"
    },
    {
        title: "Buildnow GG",
        type: "proxy",
        img: "./img/gxmes/buildnowGG.png",
        src: "https://frivwtf.com/games/buildnow-gg/index.html"
    },

    {
        title: "Airmash",
        type: "proxy",
        img: "./img/gxmes/airmash.png",
        src: "https://airmash.online"
    },
    {
        title: "Zombs Royale",
        type: "proxy",
        img: "./img/gxmes/zomb.jpg",
        src: "https://zombsroyale.io/"
    },
    {
        title: "Tough Love Arena",
        type: "proxy",
        img: "./img/gxmes/tla.png",
        src: "https://toughlovearena.com/"
    },
    {
        title: "House of Hazards",
        type: "proxy",
        img: "./img/gxmes/hoh.jpg",
        src: "https://house-of-hazards.github.io/file/"
    },
    {
        title: "Madalin Stunt Cars",
        type: "proxy",
        img: "./img/gxmes/msc.png",
        src: "https://games.crazygames.com/en_US/madalin-cars-multiplayer/index.html?v=1.281"
    },
    {
        title: "Pixel gun 3D",
        type: "proxy",
        img: "./img/gxmes/px3d.png",
        src: "https://games.crazygames.com/en_US/pixel-gun-3d/index.html?gid=pixel-gun-3d"
    },
    {
        title: "Territorial.io",
        type: "proxy",
        img: "./img/gxmes/tt.webp",
        src: "https://territorial.io"
    },
    {
        title: "Agar.io",
        type: "proxy",
        img: "./img/gxmes/agar.png",
        src: "https://agar.io/"
    },
    {
        title: "Among Us",
        type: "proxy",
        img: "./img/gxmes/amongus.jpg",
        src: "https://adfree3kh0.github.io/projects/among-us/index.html"
    },
    {
        title: "Run",
        type: "proxy",
        img: "./img/gxmes/run.jpg",
        src: "https://bgs-games.codeberg.page/games/run1.html"
    },
    {
        title: "Run 2",
        type: "proxy",
        img: "./img/gxmes/run2.png",
        src: "https://bgs-games.codeberg.page/games/run2.html"
    },
    {
        title: "2048",
        type: "proxy",
        img: "./img/gxmes/2048.png",
        src: "https://bgs-games.codeberg.page/games/2048.html"
    },
]

let customGamesJSON = JSON.parse(localStorage.getItem("customGamesJSON")) || [];
let selectedProxyEngine = localStorage.getItem("selectedProxyEngine") || "uv";
let editingGame;

function appendGameToList(g) {
    let button = document.createElement("button");
    button.className = "card";
    button.setAttribute("onclick", `NavigateToGame('${g.type}', '${g.src}', '${selectedProxyEngine}')`);
    button.innerHTML = `
        <img src="${g.img}"/>
        <p class="card-title">${g.title}</p>
    `;
    document.querySelector(".games-list").appendChild(button);
}

function appendGameToCG(g) {
    let button = document.createElement("button");
    button.className = "card";
    button.setAttribute("data-game-id", g.id);
    button.setAttribute("onclick", `NavigateToGame('${g.type}', '${g.src}', '${selectedProxyEngine}')`);
    button.innerHTML = `
        <img src="${g.img}"/>
        <p class="card-title">${g.title}</p>
    `;
    document.querySelector(".games-list").appendChild(button);
}

function appendGamesToPanel(g) {
    let button = document.createElement("button");
    button.className = "card";
    button.setAttribute("onclick", `editGame("${g.id}")`);
    button.innerHTML = `
        <img src="${g.img}"/>
        <p class="card-title">${g.title}</p>
    `;
    document.querySelector(".panel-cards").appendChild(button);
}

function reAddCGButton() {
    let existingButton = document.querySelector(".add-game-card");
    if (existingButton) {
        document.querySelector(".games-list").removeChild(existingButton);
    }

    let button = document.createElement("button");
    button.className = "card add-game-card";
    button.setAttribute("onclick", `showCGPanel()`);
    button.innerHTML = `
        <img src="./img/add-game-card.png"/>
        <p class="card-title">Custom Game</p>
    `;
    document.querySelector(".games-list").appendChild(button);
}

function generateID() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let id = '';

    for (let i = 0; i < 8; i++) {
        const randomIndex = Math.floor(Math.random() * chars.length);
        id += chars[randomIndex];
    }

    return id;
}

function addCustomGame() {
    let game_name = document.getElementById("game-name-input").value;
    let game_img = document.getElementById("game-image-input").value;
    let game_url = document.getElementById("game-url-input").value;

    if (!game_img || !game_name || !game_url) {
        notify("warn", "One or more inputs are blank!");
    } else {
        if (!isValidURL(game_img)) {
            notify("error", "Your game image is an invalid link.");
        } else {
            if (!isValidURL(game_url)) {
                notify("error", "Your game URL is an invalid link.");
            } else {
                let newGame = {
                    title: game_name,
                    type: "proxy",
                    img: game_img,
                    src: game_url,
                    id: "customGame-" + generateID()
                };
                customGamesJSON.push(newGame);
                localStorage.setItem("customGamesJSON", JSON.stringify(customGamesJSON));
                exitGamePanel();
                refreshGamesList();
            }
        }
    }
}

function refreshGamesList() {
    let gamesList = document.querySelector(".games-list");
    let panelList = document.querySelector(".panel-cards");
    document.querySelectorAll(".card").forEach(card => {
        if (gamesList.contains(card)) {
            gamesList.removeChild(card);
        }
        if (panelList.contains(card)) {
            panelList.removeChild(card);
        }
    });

    gamesJSON.forEach(game => {
        appendGameToList(game);
    });
    customGamesJSON.forEach(cgame => {
        appendGameToCG(cgame);
        appendGamesToPanel(cgame);
    });
    reAddCGButton();
}

function saveGame() {
    let currentGame = customGamesJSON.find(game => game.id === editingGame);
    let game_name = document.getElementById("game-name-input").value;
    let game_img = document.getElementById("game-image-input").value;
    let game_url = document.getElementById("game-url-input").value;

    if (currentGame) {
        if (!game_name || !game_img || !game_url) {
            notify("warn", "One or more inputs are blank.");
        } else {
            if (!isValidURL(game_img)) {
                notify("error", "Your game image isn't a valid URL.");
            } else {
                if (!isValidURL(game_url)) {
                    notify("error", "Your game link is not a valid URL.");
                } else {
                    currentGame.title = game_name;
                    currentGame.img = game_img;
                    currentGame.src = game_url;
                    localStorage.setItem("customGamesJSON", JSON.stringify(customGamesJSON));
                    editingGame = "";
                    exitGamePanel();
                    refreshGamesList();
                }
            }
        }
    } else {
        console.log("Game not found: " + currentGame);
    }
}

function deleteGame() {
    const gameIndex = customGamesJSON.findIndex(game => game.id === editingGame);

    if (gameIndex !== -1) {
        customGamesJSON.splice(gameIndex, 1);
        localStorage.setItem("customGamesJSON", JSON.stringify(customGamesJSON));
        exitGamePanel();
        refreshGamesList();
        editingGame = "";
    } else {
        console.log("Game not found: " + editingGame);
    }
}

function editGame(id) {
    let game_mainContent = document.getElementById("game-main-content");
    let panelList = document.querySelector(".panel-cards");
    let game_h1 = document.getElementById("game-h1");
    let game_mainBtns = document.getElementById("game-main-btns");
    let game_editBtns = document.getElementById("game-edit-btns");

    let currentGame = customGamesJSON.find(game => game.id === id);

    document.getElementById("game-name-input").value = "";
    document.getElementById("game-image-input").value = "";
    document.getElementById("game-url-input").value = "";

    if (currentGame) {
        editingGame = currentGame.id;
        game_mainBtns.style.display = "none";
        game_editBtns.style.display = "";
        document.getElementById("game-name-input").value = currentGame.title;
        document.getElementById("game-image-input").value = currentGame.img;
        document.getElementById("game-url-input").value = currentGame.src;
        game_h1.innerHTML = `Now editing: "${currentGame.title}"`;
        game_mainContent.style.display = "";
        panelList.style.display = "none";
    } else {
        console.log("Game not found: " + currentGame);
    }
}

function exitGamePanel() {
    let game_panel = document.getElementById("custom-game-panel");
    let curtain = document.querySelector(".curtain");
    document.getElementById("game-name-input").value = "";
    document.getElementById("game-image-input").value = "";
    document.getElementById("game-url-input").value = "";
    game_panel.style.transform = "scale(0.1)";
    curtain.style.opacity = 0;
    curtain.style.visibility = "hidden";
}

function editPanel() {
    let game_mainContent = document.getElementById("game-main-content");
    let panelList = document.querySelector(".panel-cards");
    let h1 = document.getElementById("game-h1");
    game_mainContent.style.display = "none";
    panelList.style.display = "";
    h1.innerHTML = "Select a game";
}

function showCGPanel() {
    let game_panel = document.getElementById("custom-game-panel");
    let h1 = document.getElementById("game-h1");
    let curtain = document.querySelector(".curtain");
    let game_mainContent = document.getElementById("game-main-content");
    let panelList = document.querySelector(".panel-cards");
    let game_mainBtns = document.getElementById("game-main-btns");
    let game_editBtns = document.getElementById("game-edit-btns");
    game_mainContent.style.display = "";
    panelList.style.display = "none";
    game_mainBtns.style.display = "";
    game_editBtns.style.display = "none";
    h1.innerHTML = "Add new game";
    curtain.style.visibility = "visible";
    curtain.style.opacity = 1;
    game_panel.style.transform = "scale(1)";
}

function clearAllGames() {
    customGamesJSON = [];
    localStorage.setItem("customGamesJSON", JSON.stringify(customGamesJSON));
    exitGamePanel();
    refreshGamesList();
}

document.addEventListener("DOMContentLoaded", () => {
    // Fetch from local storage
    customGamesJSON = JSON.parse(localStorage.getItem("customGamesJSON")) || [];
    
    gamesJSON.forEach(game => {
        appendGameToList(game);
    });
    customGamesJSON.forEach(game => {
        appendGameToCG(game);
        appendGamesToPanel(game);
    });
    reAddCGButton();
});

function filterGames(searchTerm) {
    const gamesList = document.querySelector(".games-list");
    gamesList.innerHTML = "";
    gamesJSON
        .filter(game => game.title.toLowerCase().includes(searchTerm.toLowerCase()))
        .forEach(game => appendGameToList(game));
    customGamesJSON
        .filter(game => game.title.toLowerCase().includes(searchTerm.toLowerCase()))
        .forEach(game => appendGameToCG(game));
}

document.getElementById("game-search").addEventListener("input", (e) => {
    filterGames(e.target.value);
});

